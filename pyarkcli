#!/usr/bin/python3

import sys,subprocess, time, re
import argparse, sqlite3
from configparser import ConfigParser
from datetime import datetime
from colorama import Fore, Back, Style
from timehelper import elapsedTime, playedTime

parser = argparse.ArgumentParser(formatter_class=argparse.RawTextHelpFormatter)
parser.add_argument('action_to_perform', action='store', choices=['servers', 'players', 'kicklist', 'linkrequests', 'delplayer', 'linkplayer', 
    'restartserver', 'chatbuffer', 'servertable', 'discordnames', 'notlinked', 'newest', 'server', 'dinowipe', 'playersraw',
    'playertable', 'oldest'], help='Action to perform')
action_group = parser.add_argument_group(title='actions')
action_group.add_argument('servers', action='store_true', help='Server infomration')
action_group.add_argument('playertable', action='store_true', help='Show players table')
action_group.add_argument('kicklist', action='store_true', help='Show kick list table')
action_group.add_argument('linkrequests', action='store_true', help='Show link requests table')
action_group.add_argument('discordnames', action='store_true', help='Show discord users table')
action_group.add_argument('restartserver', action='store_true', help='Set a server for admin restart')
action_group.add_argument('delplayer', action='store_true', help='Remove a player from the table')
action_group.add_argument('linkplayer', action='store_true', help='Link a player to a discord user')
action_group.add_argument('notlinked', action='store_true', help='Show players not linked to discord')
action_group.add_argument('newest', action='store_true', help='Show last 10 newest players joined')
action_group.add_argument('oldest', action='store_true', help='Show last 10 oldest players lastseen')
action_group.add_argument('server', action='store_true', help='Server information')
action_group.add_argument('players', action='store_true', help='Show players by last time seen')
action_group.add_argument('chatbuffer', action='store_true', help='Show the chat buffer table')
action_group.add_argument('servertable', action='store_true', help='Show the servers table table')
action_group.add_argument('dinowipe', action='store_true', help='Initiate a wild dino wipe on a server')
action_group.add_argument('playersraw', action='store_true', help='Show raw player list')

parser.add_argument('-s', '--servername', action='store', help='Ark server instance name')
parser.add_argument('-c', '--cancel', action='store_true', help='cancel a restart')


args = parser.parse_args()

configfile = '/home/ark/pyark.cfg'

YEL = Fore.YELLOW+Style.NORMAL
BYEL = Fore.YELLOW+Style.BRIGHT
CYN = Fore.CYAN+Style.NORMAL
BCYN = Fore.CYAN+Style.BRIGHT
WHT = Fore.WHITE+Style.NORMAL
BWHT = Fore.WHITE+Style.BRIGHT
MGT = Fore.MAGENTA+Style.NORMAL
BMGT = Fore.MAGENTA+Style.BRIGHT
GRN = Fore.GREEN+Style.NORMAL
BGRN = Fore.GREEN+Style.BRIGHT
RED = Fore.RED+Style.NORMAL
BRED = Fore.RED+Style.BRIGHT
RST = Fore.RESET+Style.NORMAL

class ExtConfigParser(ConfigParser):
    def getlist(self, section, option):
        value = self.get(section, option)
        return list(filter(None, (x.strip() for x in value.split(','))))

    def getlistint(self, section, option):
        return [int(x) for x in self.getlist(section, option)]

config = ExtConfigParser()
config.read(configfile)

sharedpath = config.get('general', 'shared')

sqldb = f'{sharedpath}/db/pyark.db'

clr1 = f'{BYEL}'
clr2 = f'{BCYN}'

tclr=''
trclr=''

print('    ')

conn = sqlite3.connect(sqldb)
c = conn.cursor()

now = time.time()

c.execute('DELETE from players WHERE playedtime = 0')
conn.commit()

def printplayer(feach):
    print(f'{BYEL}Player {BWHT}{feach[0]} {BMGT}{feach[1]}{RST} {BYEL}last on {tclr}{elapsedTime(now,float(feach[2]))} {BYEL}ago on {BMGT}{feach[3]} {BYEL}for {BCYN}{playedTime(feach[4])} {BYEL}joined {trclr}{elapsedTime(now,float(feach[6]))}{BYEL} ago{RST}')

def alogparser():

    log_file_path = '/home/ark/arkpy.log'
    regex = '(<property name="(.*?)">(.*?)<\/property>)'
    read_line = True

    with open(log_file_path, "r") as file:
        match_list = []
        if read_line == True:
            for line in file:
                for match in re.finditer(regex, line, re.S):
                    match_text = match.group()
                    match_list.append(match_text)
                    print match_text
        else:
            data = f.read()
            for match in re.finditer(regex, data, re.S):
                match_text = match.group()
                match_list.append(match_text)
    file.close()


def printserverinfo(each):
    c.execute('SELECT * from players')
    allplayers = c.fetchall()
    c.execute('SELECT cfgver from general')
    gencfgver = c.fetchone()

    def howmanyon(inst):
        pcnt = 0
        for row in allplayers:
            #print(row)
            diff_time = float(now) -  float(row[2])
            total_min = diff_time / 60
            minutes = int(total_min % 60)
            hours = int(total_min / 60)
            days = int(hours / 24)
            if minutes <= 1 and hours < 1 and days < 1 and row[3] == inst:
                pcnt += 1
        return pcnt

    restarted = elapsedTime(float(now),float(each[1]))
    if float(now)-float(each[1]) > 259200:
        restclr = f"{BRED}"
    elif float(now)-float(each[1]) > 172800:
        restclr = f"{BYEL}"
    else:
        restclr = f"{BGRN}"
    lwipe = elapsedTime(float(now),float(each[2]))
    if float(now)-float(each[2]) > 86400:
        wipeclr = f"{BRED}"
    elif float(now)-float(each[2]) > 43200:
        wipeclr = f"{BYEL}"
    else:
        wipeclr = f"{BGRN}"
    lvote = elapsedTime(float(now),float(each[4]))
    if float(now)-float(each[4]) > 259200:
        voteclr = f"{BRED}"
    elif float(now)-float(each[4]) > 86400:
        voteclr = f"{BYEL}"
    else:
        voteclr = f"{BGRN}"

    ply = howmanyon(each[0])
    if gencfgver[0] != each[6]:
        vertxt = f'{BRED}({int(gencfgver[0])-int(each[6])} versions behind){RST}'
    else:
        vertxt = f'{GRN}(Current){RST}'

    if each[3] == "False":
        inrest = f"{GRN}False{RST}"
    else:
        inrest = f"{BRED}TRUE{RST}"

    if ply != 0:
        mm = BGRN
    else:
        mm = BRED

    if each[7] < 5:
        nn = BRED
    elif each[7] < 15:
        nn = YEL
    else:
        nn = BGRN

    if each[3] == "True":
        tls = f'Time Left: {nn}{each[7]} Minutes'
    else:
        tls = ''
    print(f'{BYEL}Server: {BMGT}{each[0].upper()}{BYEL} - Players: {mm}{ply}/50{RST}')
    print(f'{BYEL}Configuration version: {BCYN}{each[6]}{RST} {vertxt}')
    print(f'{BYEL}Server in restart: {inrest} {BYEL}{tls}{RST}')
    print(f'{BYEL}Last restart: {restclr}{restarted}{BYEL}  Reason: {BCYN}{each[5]}{RST}')
    print(f'{BYEL}Last wilddino wipe: {wipeclr}{lwipe}{RST}')
    print(f'{BYEL}Last wipe vote: {voteclr}{lvote}{RST}')
    print('  ')


def playersraw():
    c.execute('SELECT * from players')
    allplayers = c.fetchall()

    for row in allplayers:
        pltime = playedTime(float(row[4].replace(',','')))
        laston = elapsedTime(float(now),float(row[2]))
        diff_time = float(now) -  float(row[2])
        total_min = diff_time / 60
        minutes = int(total_min % 60)
        hours = int(total_min / 60)
        days = int(hours / 24)
        if minutes <= 1 and hours < 1 and days < 1:
            active = BGRN
        elif days > 7 <= 14:
            active = YEL
        elif days > 14:
            active = BRED
        else:
            active = BCYN
        firston = datetime.fromtimestamp(float(row[6])-14400).strftime('%a, %b %d %I:%M%p')
        print(f'{active}{row[0]} \"{row[1]}\" - Connections: {row[7]} - Reward Points: {row[5]}')
        print(f' FirstON: {firston} | PlayedTime: {pltime} | LastON: {laston} on {row[3]}{RST}')
        print('  ')


def showservers():
    global tclr
    global trclr
    c.execute('SELECT cfgver from general')
    gencfgver = c.fetchone()

    print(f'{BWHT}Current Config Version: {BCYN}{gencfgver[0]}{RST}')

    print('    ')

    c.execute('SELECT * from instances')
    allservers = c.fetchall()

    for each in allservers:
        printserverinfo(each)
    print(f'{BCYN}CLUSTER PLAYERS ONLINE:{RST}')
    print('   ')
    lst = time.time()-41
    c.execute('SELECT * from players WHERE lastseen > ?', (lst,))
    lastones = c.fetchall()
    for feach in lastones:
        tt = now-float(feach[2])
        tr = now-float(feach[6])
        if tt < 86400:
            tclr = f'{BGRN}'
        elif tt < 604800:
            tclr = f'{YEL}'
        else:
            tclr = f'{RED}'
        if tr < 604800:
            trclr = f'{BGRN}'
        elif tr < 2592000:
            trclr = f'{YEL}'
        else:
            trclr = f'{RED}'

        printplayer(feach)

def restartserver(server):
    if not args.cancel:
        c.execute('UPDATE instances SET needsrestart = "True" WHERE name = ?', [args.server])
        print(f'{BYEL}server {BMGT}{args.server}{BYEL} has been set to {BRED}RESTART{RST}')
    else:
        c.execute('UPDATE instances SET needsrestart = "False" WHERE name = ?', [args.server])
        print(f'{BYEL}server {BMGT}{args.server}{BYEL} has been set to {BGRN}NOT RESTART{RST}')
    conn.commit()

def printcolmns(mtable):
    c.execute('PRAGMA table_info({})'.format(mtable))
    alldata = c.fetchall()
    ap = []
    for row in alldata:
        ap.append(f'{row[1]}[{row[0]}] {row[2]}')
    print(f'{BMGT}{ap}{RST}')
    print('  ')


def listtablewhere(mtable,colmn,val):
    #print(mtable,colmn,val)
    c.execute('SELECT * from {} WHERE {} = ""'.format(mtable,colmn))
    showtable(mtable,c.fetchall())

def listtable(mtable):
    c.execute('SELECT * from {}'.format(mtable))
    showtable(mtable,c.fetchall())

def showtable(mtable,aplay):
    sc = 0
    if aplay:
        for each in aplay:
            if sc == 0:
                sclr = f'{clr1}'
            else:
                sclr = f'{clr2}'
            print(f'{sclr}{each}{RST}')
            if sc == 1:
                sc = 0
            else:
                sc = 1
    else:
        print(f'{BYEL}{mtable} table is empty.{RST}')

def getresponce(question):
    print('    ')
    check = str(input(f"{question} : ")).lower().strip()
    try:
        return check
    except Exception as error:
        print("Please enter valid inputs")
        print(error)
        return ask_user()


def ask_question(question):
    print('   ')
    check = str(input(f"{question} (Y/N): ")).lower().strip()
    try:
        if check[0] == 'y':
            return True
        elif check[0] == 'n':
            return False
        else:
            print('Invalid Input')
            return ask_user()
    except Exception as error:
        print("Please enter valid inputs")
        print(error)
        return ask_user()

def linkplayer():
    printcolmns('players')
    listtable('players')

    nsteamid = getresponce(f'{BGRN}Enter Steam ID of player to add a discord ID too{RST}')
    print('    ')

    printcolmns('discordnames')
    listtable('discordnames')

    sdid = getresponce(f'{BGRN}Enter Discord Name to add to player {nsteamid}{RST}')

    if ask_question(f'{BGRN}Add Discord Name: {BMGT}{sdid}{BGRN} to Steam ID {BMGT}{nsteamid}{BYEL}?{RST}'):
        c.execute('UPDATE players SET discordid = ? WHERE steamid = ?', (sdid,nsteamid))
        print('    ')
        print(f'{BYEL}Discord Name: {BMGT}{sdid}{BYEL} has been added to {BMGT}{nsteamid}{RST}')
        print('    ')
    else:
        print('    ')
        print(f'{BRED}Canceled. Nothing written{RST}')
        print('    ')

    conn.commit()
    printcolmns('players')
    listtable('players')    

def delplayer():

    printcolmns('players')
    listtable('players')

    nsteamid = getresponce(f'{BGRN}Enter Steam ID of player to remove{RST}')

    c.execute('SELECT * from players')
    oplayers = c.fetchall()
    for each in oplayers:
        if each[0] == nsteamid:
            if ask_question(f'{BGRN}You will be deleting {BMGT}{each[1]}{BGRN} with steamid {BMGT}{each[0]}{BGRN} from the database. continue?{RST}'):
                c.execute('DELETE from players WHERE steamid = ?', ([args.steamid]))
                print('    ')
                print(f'{BYEL}Player {BMGT}{each[1]}{BYEL} with steamid {BMGT}{each[0]}{BYEL} has been deleted.{RST}')
                print('    ')
            else:
                print('    ')
                print(f'{BRED}Canceled. Skipping delete{RST}')
                print('   ')

    conn.commit()

    c.execute('SELECT * from players')
    alldata = c.fetchall()
    for row in alldata:
        print(row)

def newest():
    global tclr
    global trclr
    print(f'{BCYN}TOP 10 NEWEST CLUSTER PLAYERS:{RST}')
    print('   ')
    c.execute('SELECT * from players ORDER BY firstseen DESC LIMIT 10')
    lastones = c.fetchall()
    for feach in lastones:
        tt = now-float(feach[2])
        tr = now-float(feach[6])
        if tt < 86400:
            tclr = f'{BGRN}'
        elif tt < 604800:
            tclr = f'{YEL}'
        else:
            tclr = f'{RED}'
        if tr < 604800:
            trclr = f'{BGRN}'
        elif tr < 2592000:
            trclr = f'{YEL}'
        else:
            trclr = f'{RED}'

        printplayer(feach)

def oldest():
    global tclr
    global trclr
    print(f'{BCYN}TOP 10 OLDEST LAST TIME SEEN PLAYERS:{RST}')
    print('   ')
    c.execute('SELECT * from players ORDER BY lastseen ASC LIMIT 10')
    lastones = c.fetchall()
    for feach in lastones:
        tt = now-float(feach[2])
        tr = now-float(feach[6])
        if tt < 86400:
            tclr = f'{BGRN}'
        elif tt < 604800:
            tclr = f'{YEL}'
        else:
            tclr = f'{RED}'
        if tr < 604800:
            trclr = f'{BGRN}'
        elif tr < 2592000:
            trclr = f'{YEL}'
        else:
            trclr = f'{RED}'

        printplayer(feach)

def serverinfo(svr):
    global tclr
    global trclr
    c.execute('SELECT * from instances WHERE name = ?', (svr,))
    svrifo = c.fetchone()
    if not svrifo:
        print(f'{BMGT}{svr}{BRED} is not a server instance{RST}')
    else:
        printserverinfo(svrifo)
        c.execute('SELECT * from players WHERE server = ?',(svr,))
        upo = c.fetchall()
        bcnt = 0
        for ueach in upo:
            if float(time.time()) - float(ueach[2]) < 3600:
                bcnt += 1
        if bcnt == 0:
            pp = f'{BRED}'
        else:
            pp = f'{BGRN}'
        print(f'{BCYN}NUMBER OF PLAYERS IN LAST HOUR: {pp}{bcnt}{RST}')
        print('    ')
        bcnt = 0
        for ueach in upo:
            if float(time.time()) - float(ueach[2]) < 86400:
                bcnt += 1
        if bcnt == 0:
            pp = f'{BRED}'
        else:
            pp = f'{BGRN}'
        print(f'{BCYN}NUMBER OF PLAYERS IN LAST DAY: {pp}{bcnt}{RST}')
        print('    ')
        bcnt = 0
        for ueach in upo:
            if float(time.time()) - float(ueach[2]) < 604800:
                bcnt += 1
        if bcnt == 0:
            pp = f'{BRED}'
        else:
            pp = f'{BGRN}'
        print(f'{BCYN}NUMBER OF PLAYERS IN LAST WEEK: {pp}{bcnt}{RST}')
        print('    ')

        print(f'{BCYN}LAST 10 PLAYERS ONLINE:{RST}')
        print('   ')
        c.execute('SELECT * from players WHERE server = ? ORDER BY lastseen DESC LIMIT 10', (svr,))
        lastones = c.fetchall()
        for feach in lastones:
            tt = now-float(feach[2])
            if tt < 300:
                tclr = f'{BGRN}'
            elif tt < 86400:
                tclr = f'{YEL}'
            else:
                tclr = f'{RED}'
            printplayer(feach)
        print('   ')
        print(f'{BCYN}LAST 5 NEWEST PLAYERS:{RST}')
        print('   ')
        c.execute('SELECT * from players WHERE server = ? ORDER BY firstseen DESC LIMIT 5', (svr,))
        lastones = c.fetchall()
        for feach in lastones:
            tt = now-float(feach[2])
            if tt < 300:
                tclr = f'{BGRN}'
            elif tt < 86400:
                tclr = f'{YEL}'
            else:
                tclr = f'{RED}'
            printplayer(feach)
        print('   ')

def playerage():
    print(f'{BCYN}PLAYERS BY LAST TIME SEEN:{RST}')
    print('    ')
    c.execute('SELECT * from players ORDER BY lastseen DESC')
    lastones = c.fetchall()
    for feach in lastones:
        tt = now-float(feach[2])
        tr = now-float(feach[6])
        if tt < 86400:
            tclr = f'{BGRN}'
        elif tt < 604800:
            tclr = f'{YEL}'
        else:
            tclr = f'{RED}'
        if tr < 604800:
            trclr = f'{BGRN}'
        elif tr < 2592000:
            trclr = f'{YEL}'
        else:
            trclr = f'{RED}'

        printplayer(feach)
    print('   ')

def writechat(inst,whos,msg,tstamp):
    conn = sqlite3.connect(sqldb)
    c = conn.cursor()
    c.execute('SELECT * from players WHERE playername = ?', (whos,))
    isindb = c.fetchone()
    c.close()
    conn.close()
    if isindb:
        conn = sqlite3.connect(sqldb)
        c = conn.cursor()
        c.execute('INSERT INTO chatbuffer (server,name,message,timestamp) VALUES (?, ?, ?, ?)', (inst,whos,msg,tstamp))
        conn.commit()
        c.close()
        conn.close()

def resetlastwipe(inst):
    conn = sqlite3.connect(sqldb)
    c = conn.cursor()
    newtime = time.time()
    c.execute('UPDATE instances SET lastdinowipe = ? WHERE name = ?', [newtime,inst])
    conn.commit()
    c.close()
    conn.close()

def initdinowipe(sinst):
    print(f'{BYEL}Initiating a Wild Dino Wipe on server {BMGT}{sinst.capitalize()}{RST}')
    resetlastwipe(sinst)
    subprocess.run('arkmanager rconcmd "ServerChat admin initated a wild dino wipe, wiping in 10 seconds" @%s' % (yesvoters,totvoters,inst), shell=True)
    writechat(inst,'ALERT',f'### A wild dino wipe as been initiated by admin. Wiping wild dinos now.',wcstamp())
    time.sleep(10)
    subprocess.run('arkmanager rconcmd DestroyWildDinos @%s' % (inst), stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL, shell=True)
    time.sleep(2)


try:
    if args.action_to_perform == 'servers':
        showservers()
    elif args.action_to_perform == 'playertable':
        printcolmns('players')
        listtable('players')
    elif args.action_to_perform == 'kicklist':
        printcolmns('kicklist')
        listtable('kicklist')
    elif args.action_to_perform == 'linkrequests':
        listtable('linkrequests')
        listtable('linkrequests')
    elif args.action_to_perform == 'notlinked':
        listtable('players')
        listtablewhere('players','discordid','') 
    elif args.action_to_perform == 'discordnames':
        printcolmns('discordnames')
        listtable('discordnames')
    elif args.action_to_perform == 'restartserver':
        if args.servername == '':
            print('You must specify a server name with -s option.')
        else:
            restartserver(args.servername)
    elif args.action_to_perform == 'dinowipe':
        if args.servername == '':
            print('You must specify a server name with -s option.')
        else:
            initdinowipe(args.servername)
    elif args.action_to_perform == 'linkplayer':
        linkplayer()
    elif args.action_to_perform == 'delplayer':
        delplayer()
    elif args.action_to_perform == 'newest':
        newest()
    elif args.action_to_perform == 'server':
        if args.servername == None:
            print('You must specify a server name with -s option.')
        else:
            serverinfo(args.servername)
    elif args.action_to_perform == 'players':
        playerage()
    elif args.action_to_perform == 'servertable':
        printcolmns('instances')
        listtable('instances')
    elif args.action_to_perform == 'oldest':
        oldest()
    elif args.action_to_perform == 'chatbuffer':
        printcolmns('chatbuffer')
        listtable('chatbuffer')
    elif args.action_to_perform == 'playersraw':
        playersraw()



    print('       ')
    c.close()
    conn.close()
except:
    c.close()
    conn.close()
    e = sys.exc_info()
    print(e)



